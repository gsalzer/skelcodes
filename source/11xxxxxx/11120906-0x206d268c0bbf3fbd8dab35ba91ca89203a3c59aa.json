{"status":"1","message":"OK","result":[{"SourceCode":"pragma solidity ^0.6.7;\r\n\r\nabstract contract DSValueLike {\r\n    function getResultWithValidity() virtual external view returns (uint256, bool);\r\n}\r\n\r\ncontract DSM {\r\n    // --- Auth ---\r\n    mapping (address => uint) public authorizedAccounts;\r\n    /**\r\n    * @notice Add auth to an account\r\n    * @param account Account to add auth to\r\n    */\r\n    function addAuthorization(address account) external isAuthorized {\r\n        authorizedAccounts[account] = 1;\r\n        emit AddAuthorization(account);\r\n    }\r\n    /**\r\n    * @notice Remove auth from an account\r\n    * @param account Account to remove auth from\r\n    */\r\n    function removeAuthorization(address account) external isAuthorized {\r\n        authorizedAccounts[account] = 0;\r\n        emit RemoveAuthorization(account);\r\n    }\r\n    /**\r\n    * @notice Checks whether msg.sender can call an authed function\r\n    **/\r\n    modifier isAuthorized {\r\n        require(authorizedAccounts[msg.sender] == 1, \"DSM/account-not-authorized\");\r\n        _;\r\n    }\r\n\r\n    // --- Stop ---\r\n    uint256 public stopped;\r\n    modifier stoppable { require(stopped == 0, \"DSM/is-stopped\"); _; }\r\n\r\n    // --- Math ---\r\n    function add(uint64 x, uint64 y) internal pure returns (uint64 z) {\r\n        z = x + y;\r\n        require(z >= x);\r\n    }\r\n\r\n    address public priceSource;\r\n    uint16  public updateDelay = ONE_HOUR;      // [seconds]\r\n    uint64  public lastUpdateTime;              // [timestamp]\r\n    uint256 public newPriceDeviation;           // [wad]\r\n\r\n    uint16  constant ONE_HOUR = uint16(3600);   // [seconds]\r\n    uint256 public constant WAD = 10 ** 18;\r\n\r\n    struct Feed {\r\n        uint128 value;\r\n        uint128 isValid;\r\n    }\r\n\r\n    Feed currentFeed;\r\n    Feed nextFeed;\r\n\r\n    // --- Events ---\r\n    event AddAuthorization(address account);\r\n    event RemoveAuthorization(address account);\r\n    event Start();\r\n    event Stop();\r\n    event ChangePriceSource(address priceSource);\r\n    event ChangeDeviation(uint deviation);\r\n    event ChangeDelay(uint16 delay);\r\n    event RestartValue();\r\n    event UpdateResult(uint256 newMedian, uint256 lastUpdateTime);\r\n\r\n    constructor (address priceSource_, uint256 deviation) public {\r\n        require(both(deviation > 0, deviation < WAD), \"DSM/invalid-deviation\");\r\n        authorizedAccounts[msg.sender] = 1;\r\n        priceSource = priceSource_;\r\n        newPriceDeviation = deviation;\r\n        if (priceSource != address(0)) {\r\n          (uint256 priceFeedValue, bool hasValidValue) = getPriceSourceUpdate();\r\n          if (hasValidValue) {\r\n            nextFeed = Feed(uint128(uint(priceFeedValue)), 1);\r\n            currentFeed = nextFeed;\r\n            lastUpdateTime = latestUpdateTime(currentTime());\r\n            emit UpdateResult(uint(currentFeed.value), lastUpdateTime);\r\n          }\r\n        }\r\n        emit AddAuthorization(msg.sender);\r\n        emit ChangePriceSource(priceSource);\r\n        emit ChangeDeviation(deviation);\r\n    }\r\n\r\n    // --- Boolean Logic ---\r\n    function both(bool x, bool y) internal pure returns (bool z) {\r\n        assembly{ z := and(x, y)}\r\n    }\r\n\r\n    // --- Math ---\r\n    function subtract(uint x, uint y) public pure returns (uint z) {\r\n        z = x - y;\r\n        require(z <= x);\r\n    }\r\n    function multiply(uint x, uint y) public pure returns (uint z) {\r\n        require(y == 0 || (z = x * y) / y == x);\r\n    }\r\n    function wmultiply(uint x, uint y) public pure returns (uint z) {\r\n        z = multiply(x, y) / WAD;\r\n    }\r\n\r\n    // --- Administration ---\r\n    function stop() external isAuthorized {\r\n        stopped = 1;\r\n        emit Stop();\r\n    }\r\n    function start() external isAuthorized {\r\n        stopped = 0;\r\n        emit Start();\r\n    }\r\n\r\n    function changePriceSource(address priceSource_) external isAuthorized {\r\n        priceSource = priceSource_;\r\n        emit ChangePriceSource(priceSource);\r\n    }\r\n\r\n    // --- Utils ---\r\n    function currentTime() internal view returns (uint) {\r\n        return block.timestamp;\r\n    }\r\n\r\n    function latestUpdateTime(uint timestamp) internal view returns (uint64) {\r\n        require(updateDelay != 0, \"DSM/update-delay-is-zero\");\r\n        return uint64(timestamp - (timestamp % updateDelay));\r\n    }\r\n\r\n    function changeNextPriceDeviation(uint deviation) external isAuthorized {\r\n        require(both(deviation > 0, deviation < WAD), \"DSM/invalid-deviation\");\r\n        newPriceDeviation = deviation;\r\n        emit ChangeDeviation(deviation);\r\n    }\r\n\r\n    function changeDelay(uint16 delay) external isAuthorized {\r\n        require(delay > 0, \"DSM/delay-is-zero\");\r\n        updateDelay = delay;\r\n        emit ChangeDelay(updateDelay);\r\n    }\r\n\r\n    function restartValue() external isAuthorized {\r\n        currentFeed = nextFeed = Feed(0, 0);\r\n        stopped = 1;\r\n        emit RestartValue();\r\n    }\r\n\r\n    function passedDelay() public view returns (bool ok) {\r\n        return currentTime() >= add(lastUpdateTime, updateDelay);\r\n    }\r\n\r\n    function updateResult() external stoppable {\r\n        require(passedDelay(), \"DSM/not-passed\");\r\n        (uint256 priceFeedValue, bool hasValidValue) = getPriceSourceUpdate();\r\n        if (hasValidValue) {\r\n            currentFeed.isValid = nextFeed.isValid;\r\n            currentFeed.value   = getNextBoundedPrice();\r\n            nextFeed            = Feed(uint128(priceFeedValue), 1);\r\n            lastUpdateTime      = latestUpdateTime(currentTime());\r\n            emit UpdateResult(uint(currentFeed.value), lastUpdateTime);\r\n        }\r\n    }\r\n\r\n    // --- Getters ---\r\n    function getPriceSourceUpdate() internal view returns (uint256, bool) {\r\n        try DSValueLike(priceSource).getResultWithValidity() returns (uint256 priceFeedValue, bool hasValidValue) {\r\n          return (priceFeedValue, hasValidValue);\r\n        }\r\n        catch(bytes memory) {\r\n          return (0, false);\r\n        }\r\n    }\r\n\r\n    function getNextBoundedPrice() public view returns (uint128 boundedPrice) {\r\n        boundedPrice = nextFeed.value;\r\n        if (currentFeed.value == 0) return boundedPrice;\r\n\r\n        uint128 lowerBound = uint128(wmultiply(uint(currentFeed.value), newPriceDeviation));\r\n        uint128 upperBound = uint128(wmultiply(uint(currentFeed.value), subtract(multiply(uint(2), WAD), newPriceDeviation)));\r\n\r\n        if (nextFeed.value < lowerBound) {\r\n          boundedPrice = lowerBound;\r\n        } else if (nextFeed.value > upperBound) {\r\n          boundedPrice = upperBound;\r\n        }\r\n    }\r\n\r\n    function getNextPriceLowerBound() public view returns (uint128) {\r\n        return uint128(wmultiply(uint(currentFeed.value), newPriceDeviation));\r\n    }\r\n\r\n    function getNextPriceUpperBound() public view returns (uint128) {\r\n        return uint128(wmultiply(uint(currentFeed.value), subtract(multiply(uint(2), WAD), newPriceDeviation)));\r\n    }\r\n\r\n    function getResultWithValidity() external view returns (uint256, bool) {\r\n        return (uint(currentFeed.value), currentFeed.isValid == 1);\r\n    }\r\n\r\n    function getNextResultWithValidity() external view returns (uint256, bool) {\r\n        return (nextFeed.value, nextFeed.isValid == 1);\r\n    }\r\n\r\n    function read() external view returns (uint256) {\r\n        require(currentFeed.isValid == 1, \"DSM/no-current-value\");\r\n        return currentFeed.value;\r\n    }\r\n}","ABI":"[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"priceSource_\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"deviation\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"AddAuthorization\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint16\",\"name\":\"delay\",\"type\":\"uint16\"}],\"name\":\"ChangeDelay\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"deviation\",\"type\":\"uint256\"}],\"name\":\"ChangeDeviation\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"priceSource\",\"type\":\"address\"}],\"name\":\"ChangePriceSource\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"RemoveAuthorization\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[],\"name\":\"RestartValue\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[],\"name\":\"Start\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[],\"name\":\"Stop\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newMedian\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"lastUpdateTime\",\"type\":\"uint256\"}],\"name\":\"UpdateResult\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"WAD\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"addAuthorization\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"authorizedAccounts\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint16\",\"name\":\"delay\",\"type\":\"uint16\"}],\"name\":\"changeDelay\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"deviation\",\"type\":\"uint256\"}],\"name\":\"changeNextPriceDeviation\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"priceSource_\",\"type\":\"address\"}],\"name\":\"changePriceSource\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getNextBoundedPrice\",\"outputs\":[{\"internalType\":\"uint128\",\"name\":\"boundedPrice\",\"type\":\"uint128\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getNextPriceLowerBound\",\"outputs\":[{\"internalType\":\"uint128\",\"name\":\"\",\"type\":\"uint128\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getNextPriceUpperBound\",\"outputs\":[{\"internalType\":\"uint128\",\"name\":\"\",\"type\":\"uint128\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getNextResultWithValidity\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getResultWithValidity\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"lastUpdateTime\",\"outputs\":[{\"internalType\":\"uint64\",\"name\":\"\",\"type\":\"uint64\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"x\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"y\",\"type\":\"uint256\"}],\"name\":\"multiply\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"z\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"newPriceDeviation\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"passedDelay\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"ok\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"priceSource\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"read\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"removeAuthorization\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"restartValue\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"start\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"stop\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"stopped\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"x\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"y\",\"type\":\"uint256\"}],\"name\":\"subtract\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"z\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"updateDelay\",\"outputs\":[{\"internalType\":\"uint16\",\"name\":\"\",\"type\":\"uint16\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"updateResult\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"x\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"y\",\"type\":\"uint256\"}],\"name\":\"wmultiply\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"z\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"}]","ContractName":"DSM","CompilerVersion":"v0.6.7+commit.b8d736ae","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"0000000000000000000000005daf352ca59fbfd4cc67a53df857bee9b29183bc0000000000000000000000000000000000000000000000000b1a2bc2ec500000","EVMVersion":"Default","Library":"","LicenseType":"None","Proxy":"0","Implementation":"","SwarmSource":"ipfs://2b54de550627616b7b046c8b123369ed4e9f7334bffeff5cb998b9acf54a71f1"}]}