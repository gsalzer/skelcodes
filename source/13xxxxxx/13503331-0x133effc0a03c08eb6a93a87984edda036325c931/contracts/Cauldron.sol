/* 
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooodddddxxxxxddddddooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooddxkO00KKXXNNNNNNXXXKKK0Okkxddoooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooodoooodxk0KXNWWMMMMMMMMMMMMMMMMMMMMWWNXKOkxdooooodoooooooooooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooddk0KNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOdooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooddk0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKkdooodddooooooooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooodx0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdoodO0Okxddoooooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooodkKNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN0dookXWWNXK0kxdooodoooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooodOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0dodONMMMMMWXOxooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooodOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdod0WMMMMMMWXkdooooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooodoooodkKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdokXMMMMMMMMN0doooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooodx0NMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXxod0WMMMMMMMMWKxdoooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooodooodkXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOdx0NWMMMMMMMMMWKxdooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooodONMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKxox0WMMMMMMMMMMMMWXkdoooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooox0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWNWMMMMMMMMMWNX0OkO0XWMMMMMMMMMMWXxoooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooxKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNXKKK0000K00KWMMMMMMMMMMMWNKkONMMMMMMMMMMMWKxooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooxKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXKK000KKKXXNNWWWNK0NMMMMMMMMMMMMNKXWMMMMMMMMMMMMW0doooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooxKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWXKK0KKKXNWWMMMMMMMMMMMWXKXWMMMMMMMMMMWWWMMMNKKKKKKKKXXKkdooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooood0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXK0KKNWWMMMMMMMMMMMMMMMMMMMWKXWMMMMMMMMMMMMMMWK0NNWWWWNNNXXKOkxdooooooooooooooooooooooooooooo
ooooooooooooooooooooooodONMMMMMMMMMMMMMMMMMMMMMMMMMMWNKKKKNWMMMMMMMMMMMMMMMMMMMMMMMMMWXXWMMMMMMMMMMMMMXKNMMMMMMMMMMMMMWNKOxdoooooooooooooooooooooooooo
oooooooooooooooooooooooxXWMMMMMMMMMMMMMMMMMMMMMMMMWXKKXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNNWMMMMMMMMMMMWXNWMMMMMMMMMMMMMMMMWX0xdoooooooooooooooooooooooo
ooooooooooooooooooooood0WMMMMMMMMMMMMMMMMMMMMMMMWNXXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWMMMMMMMMMMMWNWMMMMMMMMMMMMMMMMMMMWXkdooooooooooooooooooooooo
ooooooooooooooooooooookXMMMMMMMMMMMMMMMMMMMMMMMWNNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdoooooooooooooooooooooo
ooooooooooooooooooooodOWMMMMMMMMMMMMMMMMMMMMMMWWWMMMMMMMMMMMMMMMMMWNXK00O00KXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNNWWMMMMMMMMMMMMMMNkdooooooooooooooooooooo
oooooooooooooooooooood0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNKOkxddoooooddxOKNWMMMMMMMMMMMMMMMMMMMMMMMWXOkk0KNWMMMMMMMMWNNNKxdooooooooooooooooooooo
ooooooooooooooooooodookNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNKOxdoooooodooooooddk0NWMMMMMMMMMMMMMMMMMMMMN0xdooodx0NWMMMMMMN0xxdooooooooooooooooooooooo
oooooooooooooooooooooodKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOxdooooooooooooooooooodx0NMMMMMMMMMMMMMMMMMMNOdodooooodxKWMMMMMWKxooooooooooooooooooooooooo
oooooooooooooooooooooookXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOxdooooooooooooooooooooooodxKWMMMMMMMMMMMMMMMNOdooooooooood0NMMMWKxoooooooooooooooooooooooooo
ooooooooooooooooooooooodONMMMMMMMMMMMMMMMMMMMMMMMMMMMWN0xoooodooooooooooooooooooooooodOXWMMMMMMMMMMMMW0doooodoooooood0WMWKxooooooooooooooooooooooooooo
ooooooooooooooooooooooood0WMMMMMMMMMMMMMMMMMMMMMMMMMWXkdoooooooooooooooooooooooooodooodxKWMMMMMMMMMMWKxooooooooooooooxXWXkoooooooooooooooooooooooooooo
oooooooooooooooooooooooooxKWMMMMMMMMMMMMMMMMMMMMMMMWXkdooooooooooooooooooooooooooooooooox0WMMMMMMMMMNkoooooooooooooooxKW0doooooooooooooooooooooooooooo
ooooooooooooooooooooooooooxXWMMMMMMMMMMMMMMMMMMMMMMNOdooooooooooooooooooooooooooooooooooox0WMMMMMMMWKxoooooooooooooodONWOdoooooooooooooooooooooooooooo
oooooooooooooooooooooooooodkXWMMMMMMMMMMMMMMMMMMMMMKxoooooooooooooooooooooooooooooooooooooxKWMMMMMMW0dooooooooooooodkXWW0doooooooooooooooooooooooooooo
ooooooooooooooooooooooooooodkXWMMMMMMMMMMMMMMMMMMMW0dooooooooooooooooooooooooooooooooooooodONMMMMMMWOdoooooooooooox0NMMMNOdooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooxKWMMMMMMMMMMMWWMMMMMWKdooooooooooooooooooooooooooooooooooooookNMMMMMMWXOxdooooooodxOXWMMMMWNkdoooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooxKWMMMMMMMMMMNXNMMMMMNkoooooooooooooooooooooooooooooooooooood0WMMMMWNWMWXK0OOOOO0KNWMMMMMMMNOddooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooodOXWMMMMMMMMMNKNMMMMWKxdooooooooooooooooooooooooooooooooodx0NMMMMNOxOXWMMMMMMMMMMMMMMMMMMWKxoooddoooooooooooooooooooooo
ooooooooooooooooooooooooooooooooddk0XWWMMMMMWX0XMMMMWXkdooooooooooooooooooooooooooooooodkXWMMMMNOdooxKWMMMMMMMMMMMMMMWWN0xoooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooodkOKNWWMMNO0WMMMMWN0xdodooooooooooooooooooooooooodkKNMMMMMW0ddkOkkXWMMMMMMMWNXK0Okkxdooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooodxkOKX00NMMMMMMMWNKOxdooooooooooooooooooooodk0XWMMMMMMMKxdONWWXXWMMMMMWKOxddoooodoooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooox0NMMMMMMMMMMMWNKOkxdooooooooooooddxk0XNWMMMMMMMMW0dONMMMMMMMMMMNOdooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooood0NMMMMMMMMMMMMMMMMWNK00OkxxxkkO00KXNWMMMMMMMMMMMMMX0NMMMMMMMMMMMXxoooooooooodooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooodOXMMMMMMMMMMMMMMMMMMMMMWWWNWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkdooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooodkKWMMMMMMNKKNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNNNWMWNNWWN0xooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooodOKNWWWN0ddkKXXXNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNNWWNNNNNNXNNXXNXOxdooodoooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooodxkkkxddodddddxxk0KNWMMMWWMMWWMMMMMMMMMMMMWNNNXNWNXNMWNNXNWWNNWWXOdooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooodxOXNNNNXKXNNWWWNNWMMMNNNNXKNMMWXNWMWNXXMMMNNWN0dooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooodONWMMWXKXWWNXXNNNNWNXWMMNKNMMMWNWMMMWNNMMMNKOdodoooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooood0WMMMWNXNMMWXXWMMNXXWMMMWXWMMMMNNWMMMWNNWNXOdodooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooododONMMMWNXNMMWNNMMMNXWMMMMWNWMMMMWNNMMWNKkxxddoooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooxO000O0XNWWNXNMMWXNMMMMMWNNMMMMMNKKKOkdoodoooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooodkkkkkk0K0OOXWWWXNNXNMMMWWKxddoooooooooooooooooooooooooooooooooooooooooooooo
ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooodoooooooooddoodxkOkdxkkk00OOkddoodooooooooooooooooooooooooooooooooooooooooooooo
oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo */

//Rottie Created and Developed by CryptidLabs.Xyz

// SPDX-License-Identifier: MIT
pragma solidity >=0.8.0 <0.9.0;

import "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Strings.sol";
import "@openzeppelin/contracts/finance/PaymentSplitter.sol";

contract Cauldron is ERC721Enumerable, PaymentSplitter, Ownable {
  using Strings for uint256;


 bool public _isMintingActive = false;
  bool public _isBaseUriSet = false;
  
  mapping(address => uint256) public admintsRemaining;

  uint256 public constant MAX_SUPPLY = 6666;// Max supply

  uint256 public constant PRICE = 0.031 ether;

  uint256 private _TokenId = 0; 

  string private _baseUri = 'https://www.ipfs.infura.io/ipfs/QmRHKrDsYiwH15RWQLik5Jsz4Q1cF8BRETSSHL2LRPGoBJ';
  string internal _basestring = 'http://ipfs.infura.io/ipfs/QmPRp5uSspbA6oLVrVDn3JLtXUKo8oiVe6eqA6UgpZjGPX/';

  uint256 public REVEAL_TIMESTAMP;
  uint256 public offsetBlock;
  uint256 public offset;
  uint256 public endmagic;
  uint256 public magic;
  bool public _isRotten ;
  


  event Mint(address _to, uint256 _amount);

  constructor(address[] memory payees, uint256[] memory shares) ERC721("Rotties", "ROT") PaymentSplitter(payees, shares) {
      for (uint i = 0; i < payees.length; i++) {
      admintsRemaining[payees[i]] = 20;
    }
  }

function mint(uint256 amount) public payable {
    require(_isMintingActive, "Cauldron: sale is not active");
    require(amount > 0, "Cauldron: must mint more than 0");
    require(amount <= 20, "Cauldron: must mint fewer than 20");
    require(_TokenId < MAX_SUPPLY, "Cauldron: sale has ended");
    require(_TokenId + amount <= MAX_SUPPLY, "Cauldron: exceeds max supply");
    require(amount * PRICE == msg.value, "Cauldron: must send correct ETH amount");

    for (uint i = 0; i < amount; i++) {
      _TokenId = _TokenId + 1;
      _mint(msg.sender, _TokenId);
    }
    
    emit Mint(msg.sender, amount);

    if (offsetBlock == 0 && (totalSupply() == MAX_SUPPLY || block.timestamp >= REVEAL_TIMESTAMP)) {
        offsetBlock = block.number;
    }
  }

  function admint(uint256 amount) public {
    require(admintsRemaining[msg.sender] > 0, "Cauldron: message sender has no admints remaining");
    require(admintsRemaining[msg.sender] - amount >= 0, "Cauldron: exceeds number of admints remaining");
    require(amount > 0, "Cauldron: must mint more than 0");
    require(_TokenId < MAX_SUPPLY, "Cauldron: sale has ended");
    require(_TokenId + amount <= MAX_SUPPLY, "Cauldron: exceeds max supply");

    for (uint i = 0; i < amount; i++) {
      _TokenId = _TokenId + 1;
      _mint(msg.sender, _TokenId);
    }
    
    emit Mint(msg.sender, amount);

    if (offsetBlock == 0 && (totalSupply() == MAX_SUPPLY || block.timestamp >= REVEAL_TIMESTAMP)) {
        offsetBlock = block.number;
    }
  }


  function toggleMinting() public onlyOwner {
    if (_TokenId == 0) {
      REVEAL_TIMESTAMP = block.timestamp + 24 hours;
      endmagic = block.timestamp + (6 days);
      magic = endmagic + (334 days);
    }

    _isMintingActive = !_isMintingActive;
  }


  function finalizeoffset() public {
    require(offset == 0, "Cauldron: Starting index is already set");
    require(offsetBlock != 0, "Cauldron: Starting index block must be set");
    
    offset = uint(blockhash(offsetBlock)) % MAX_SUPPLY;
    if (block.number - offsetBlock > 255) {
        offset = uint(blockhash(block.number - 1)) % MAX_SUPPLY;
    }

    if (offset == 0) {
        offset = 1;
    }
  }

  function endMinting() public onlyOwner {

    _isMintingActive = false;
  }

  function setBasestring(string memory basestring) public onlyOwner {

    _basestring = basestring;
    
  }
  function setBaseURI(string memory baseUri) public onlyOwner {

    _baseUri = baseUri;
    _isBaseUriSet = true;
  }
  function setBaseURII(string memory baseUri) internal{

    _baseUri = baseUri;

  }

  function _baseURI() internal view virtual override returns (string memory) {
    return _baseUri;
  }

  function trigger() public onlyOwner {

    _isRotten = !_isRotten;
    if (_isRotten){
      setBaseURII(string(abi.encodePacked(_basestring,'Rotten/')));
    }
     else if (!_isRotten){
      setBaseURII(string(abi.encodePacked(_basestring,'Rottie/')));
     }
  }
  function rotter() internal {

    if(block.timestamp> endmagic){
    _isRotten = true;
    magic = endmagic + (334 days);
    setBaseURII(string(abi.encodePacked(_basestring,'Rotten/')));
    }
    else if (block.timestamp > magic){
      _isRotten = false;
      endmagic = block.timestamp + (31 days);
      setBaseURII(string(abi.encodePacked(_basestring,'Rottie/')));
    }
  }

  function tokenURI(uint256 tokenId) public view virtual override returns (string memory) {
    require(_exists(tokenId), "Cauldron: URI query for nonexistent token");


    string memory baseURI = _baseURI();
    uint256 index = ((tokenId + offset - 1) % MAX_SUPPLY) + 1;

    if (offset == 0) {
      return string(abi.encodePacked(baseURI));
    }
    else{
      return string(abi.encodePacked(baseURI,index.toString()));
    }
  }
  

  function withdraw(address _target) public onlyOwner {
    payable(_target).transfer(address(this).balance);
  }
}
