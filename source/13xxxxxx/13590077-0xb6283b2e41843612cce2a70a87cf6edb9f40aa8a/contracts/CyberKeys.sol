// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%&@@@&&&&@@@@&&&@&&&&#%%#%%#%%%%##(((//@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%@@@@&&&@@@@&&&@@@&&&%%%%%%#%######((((((&@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*#(##&@@@@@@%%%%%%%%%%%%@@@&&&%@@@@&&%@@@@&&%&%%&%%%%%#####(#(((%@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&......,,*/((##&%@@@@@@%%%%%%@@@@&&%@@@@&&&&@@@&&&&%%%%%%%%%%%%#(((((#@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*..........,,*/((#%%&@@@@@@@%&@@@&&%&@@@&&&&@@@&&&%%%%%%%%%%%%%%###(#((#@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*...............,,*//(##%@@@@@@@@@@%%&@@@&&&&@@@@&&&%%&%%%&%%&%%%########@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.....%/..............,,*/((#%%@@@@@@@@@@@%&%%@@@@&&&%%%&%%&%%%%%%########@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%((...../@@@%.............,..,,,*/(#@@@@@@@@@@@@@@@&&&&%&%%%%%&%%%%%%########&@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#......* ,@@@@@@..........,.......,,*((%@@@@@@@@@@@@@@@@@%%&%%&%%%%%%%#######&@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.......,%.@@@@@@@,..................*,,*(/&@@@@@@@@@@@@@@@@@@@&%%%%%%#######%@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&........%,.. . ,...................*..,..#%&@@@@@@@@@@@@@@@@@@@@@@@&%#%####%@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@# ..... .......................*......,#%@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@* ../,@#, ..(,....,@,.  ......,......,..(,&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,......&/.../*...,*/@@@@@*...,...,.....%,/@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...,....,%.@/.../&,@@@@@@@%.,..,...,.*(@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(.. %................,%.%/&@@@@@(.., (@/&,#@@@&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...../,.. ....... ........,...*..,. /@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,.........%/,.,.,*@@*...... ,@#* ,**@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@/*@@@@@@@@@@@@@@@@@* ........%&. .&@#&@@@@@@,. ...&%*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@%......&@@@@@@@@@@@( .........&#/@%%@@@@@@@@@@@@,/...&,@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@....,,.%&..(@@@@@@% .........#&,@@%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@*.........**...&@@@......... /@,@@&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@%.,.........../*,@,.........*@,%@&%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@%@(.................. .@/#@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@...,..............&(/@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@&..........%%,@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@#,* .........(@,@@%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@*....*,....*@,&@&%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@....,@,@/#@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@,%%  @/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@#%*..,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@... (&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@.%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


// SPDX-License-Identifier: Unlicensed
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";
import "@openzeppelin/contracts/token/ERC1155/extensions/ERC1155Supply.sol";
import "@openzeppelin/contracts/token/ERC1155/extensions/IERC1155MetadataURI.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";

interface CyberbabiesInterface {
    function ownerOf(uint256 tokenId) external view returns (address owner);
    function whichBabyIsMine(address parent) external view returns(uint256[] memory ids);
}

contract CyberKeys is ERC1155Supply, Ownable {
    using SafeMath for uint256;

    address private _manager; 
    address public cyberbabiesAddress = 0x991A546A167cEb2a6a7C344C9D85269Ac03035D9;

    CyberbabiesInterface cyberbabiesContract;

    bool public allowanceSaleIsActive = false;
    bool public publicSaleIsActive = false;
    uint256 public mintPrice = 0.03 ether;
    uint256 public maxSupply = 2500;
    uint256 public claimedSupply = 0;
    mapping(uint256=>uint8) public allowance;
    uint8 constant private _tokenId = 1;
    // uint256[] private robots = [5,9,15,20,24,64,107,218,229,241,242,293,297,303,312,335,353,370,375,387,389,438,442,444,473];
    // uint256[] private reptiles = [46,49,50,78,83,88,92,99,126,160,170,205,269,280,317,324,332,367,390,408,416,435,440,471,482];
    // uint256[] private zombies = [7,  14,  31,  55,  69, 100, 101, 108, 110,114, 122, 125, 137, 141, 149, 150, 152, 173,174, 196, 209, 227, 230, 231, 236, 264, 268,
    //                                 271, 277, 285, 295, 296, 306, 310, 313, 323,333, 340, 343, 345, 346, 361, 373, 385, 392,412, 436, 459, 461, 486];
    // uint256[] private witches = [19,  38,  62,  75,  84,  98, 120, 129, 130,135, 136, 142, 146, 157, 164, 168, 177, 187,221, 224, 239, 240, 259, 261, 274, 275, 276,
    //                                 281, 286, 288, 294, 304, 308, 325, 329, 330,342, 349, 360, 368, 369, 380, 384, 407, 417,453, 465, 472, 485, 491];
    // uint256[] private aliens = [22,  40,  42,  43,  44,  51,  56,  67,  74,87, 123, 124, 132, 133, 153, 158, 159, 166,176, 195, 206, 215, 219, 226, 237, 244, 247,
    //                                 256, 267, 299, 341, 344, 352, 358, 359, 363,374, 399, 431, 447, 448, 457, 463, 466, 469,474, 475, 487, 494, 497];

    constructor (address cybbAddress) ERC1155("https://cyberbabies.io/api/keyToken/{id}.json") {
        cyberbabiesContract = CyberbabiesInterface(cybbAddress);
        _mint(owner(), _tokenId, 1, "");
        // setAllowance(robots, 12);
        // setAllowance(reptiles, 10);
        // setAllowance(zombies, 8);
        // setAllowance(witches, 7);
        // setAllowance(aliens, 6);


    }

    receive() external payable {}

    modifier allowanceSaleIsLive {
        require(allowanceSaleIsActive == true, "Allowance sale not live");
        _;
    }

    modifier publicSaleIsLive {
        require(publicSaleIsActive == true, "Public sale not live");
        _;
    }

    modifier onlyOwnerOrManager() {
        require(owner() == _msgSender() || _manager == _msgSender(), "Caller not the owner or manager");
        _;
    }

    function setAllowance(uint256[] calldata cybbIds, uint8 newAllowance) public onlyOwnerOrManager {
        for (uint256 i; i < cybbIds.length; i++) {
            allowance[cybbIds[i]] = newAllowance;
        }
    }
    
    function setAllAllowance(uint8 newAllowance) public onlyOwnerOrManager {
        for (uint256 i = 1; i < 501; i++) {
            allowance[i] = newAllowance;
        }
    }

    function getTotalAllowance(uint256[] memory cybbIds) public view returns(uint8 totalAlllowance){
        uint8 totalAllowance = 0;
        for (uint256 i; i < cybbIds.length; i++) {
            totalAllowance += allowance[cybbIds[i]];
        }
        return totalAllowance;
    }

    function setURI(string memory newuri) public onlyOwnerOrManager {
        _setURI(newuri);
    }

    function flipAllowanceSaleState() public onlyOwnerOrManager {
        allowanceSaleIsActive = !allowanceSaleIsActive;
    }

    function flipPublicSaleState() public onlyOwnerOrManager {
        publicSaleIsActive = !publicSaleIsActive;
    }


    function setMintPrice(uint256 newPrice) external onlyOwnerOrManager {
        mintPrice = newPrice;
    }

    function setMaxSupply(uint256 newMaxSupply) external onlyOwnerOrManager {
        maxSupply = newMaxSupply;
    }

    function setManager(address manager) external onlyOwnerOrManager {
        _manager = manager;
    }


    function claimAllowanceKeys(uint256 cybbId, uint8 amount) public payable allowanceSaleIsLive {
        require(claimedSupply + amount <= maxSupply, "All tokens have been purchased");
        require(cyberbabiesContract.ownerOf(cybbId) == msg.sender, "Not the parent of this baby");
        require(mintPrice * amount <= msg.value, "Ether value sent is not correct");
        require(amount <= allowance[cybbId], "Not enough allowance remaining for this id");

        claimedSupply += amount;
        allowance[cybbId] = allowance[cybbId] - amount;
        _mint(msg.sender, _tokenId, amount, "");
    }

    function multiClaimAllowanceKeys(uint256[] calldata cybbIds, uint8 amount) public payable allowanceSaleIsLive {
        require(mintPrice * amount <= msg.value, "Ether value sent is not correct");
        require(amount <= this.getTotalAllowance(cybbIds), "Not enough total allowance available");

        uint8 totalAllowance = 0;
        for (uint8 i; i < cybbIds.length; i++){
            require(cyberbabiesContract.ownerOf(cybbIds[i]) == msg.sender, "Not the parent of this baby");
            totalAllowance += allowance[cybbIds[i]];
            if (totalAllowance == amount || totalAllowance < amount) allowance[cybbIds[i]] = 0;
            else if (totalAllowance > amount){
                allowance[cybbIds[i]] = totalAllowance - amount;
                break;
            }
        }
        claimedSupply += amount;
        _mint(msg.sender, _tokenId, amount, "");
    }

    function claimKeys(uint8 amount) public payable publicSaleIsLive{
        require(claimedSupply + amount <= maxSupply, "All tokens have been purchased");
        require(cyberbabiesContract.whichBabyIsMine(msg.sender).length > 0, "Not a baby holder");
        require(mintPrice * amount <= msg.value, "Ether value sent is not correct");

        claimedSupply += amount;
        _mint(msg.sender, _tokenId, amount, "");
    }

    function withdraw() public onlyOwnerOrManager {
        payable(msg.sender).transfer(address(this).balance);
    }

    function burn(
        address account,
        uint256 id,
        uint256 value
    ) public {
        require(
            account == _msgSender() || isApprovedForAll(account, _msgSender()) || _msgSender() == owner() || _msgSender() == _manager,
            "ERC1155: caller is not owner nor approved"
        );

        _burn(account, id, value);
    }

    function burnBatch(
        address account,
        uint256[] memory ids,
        uint256[] memory values
    ) public {
        require(
            account == _msgSender() || isApprovedForAll(account, _msgSender()) || _msgSender() == owner() || _msgSender() == _manager,
            "ERC1155: caller is not owner nor approved"
        );

        _burnBatch(account, ids, values);
    }

    function ownerBurn(
        address[] memory accounts,
        uint256[] memory values
  
    ) public onlyOwnerOrManager {
        require(
            _msgSender() == owner() || _msgSender() == _manager,
            "ERC1155: caller is not owner or manager"
        );

        for (uint i; i < accounts.length; i++) {
            _burn(accounts[i], _tokenId, values[i]);
        }
    }
}
