// SPDX-License-Identifier: Unlicense

pragma solidity^0.8.0;

import "hardhat/console.sol";

interface ICorruptionsDataMapper {
    function setValue(uint256 mapIndex, uint256 key, uint256 value) external;
    function valueFor(uint256 mapIndex, uint256 key) external view returns (uint256);
}

interface ICorruptions {
    function ownerOf(uint256 tokenID) external returns (address);
    function insight(uint256 tokenID) external view returns (uint256);
}

interface ICorruptionsPaletteToCharacterHelper {
    function prepareCanvas(string[] memory charPaletteStrings, uint256 numChars, bytes memory composition) external pure returns (string[32] memory);
}

contract CorruptionsTemporalFragmentDeviationWriter {
    address constant public chosenAddress = 0x4fFFFF3eD1E82057dffEe66b4aa4057466E24a38;

    bytes constant public data0 = hex"00000000000000000000000000000000000000000000000000000000000000000001000100010001000100010001000100010001000100010001000100000001010101010101010101010101010101010101010101010101010101010000000101010101010101010101010101010101010101010101010101010000000101010101010101010101010101010101010101010101010101010101000000010101010101010101020202020202020202010101010101010101000000010101010101010102020202020202020202020303010101010101010100000001010101010202020201010101010101010103030303010101010100000001010101010102020101010101010101010101010103030101010101010000000101010101020201010101010101010101010101030301010101010000000101010101010202010101010101010101010101010303010101010101000000010101010102020101010101010101010101010103030101010101000000010101010101020201010101010101010101010101030301010101010100000001010101010202020201010101010101010103030303010101010100000001010101010101010202020202020202020202030301010101010101010000000101010101010103030202020202020202020202010101010101010000000101010101010303030301010101010101010102020202010101010101000000010101010103030101010101010101010101010102020101010101000000010101010101030301010101010101010101010101020201010101010100000001010101010303010101010101010101010101010202010101010100000001010101010103030101010101010101010101010102020101010101010000000101010101030301010101010101010101010101020201010101010000000101010101010303030301010101010101010102020202010101010101000000010101010101010303020202020202020202020201010101010101000000010101010101010101010202020202020202020101010101010101010100000001010101010101010101010101010101010101010101010101010100000001010101010101010101010101010101010101010101010101010101010000000101010101010101010101010101010101010101010101010101010000000101010101010101010101010101010101010101010101010101010101000000010001000100010001000100010001000100010001000100010001000000000000000000000000000000000000000000000000000000000000000000";

    bytes constant public data1 = hex"00000001000100010001000100010202020100010001000100010001000000000100010100010001000100010102020201010001000100010001010001000000000101000100010001000101020202010100010001000100010100000001010101010101010101010101020202020201010101010101010101010101000000010000000100000100010202020202010001000001000000010000000001000101010101030101010102020302020101010103010101010100010000000001000100010301020102020203020202010201030100010001000000010101010001010203020202020202030202020202020302010100010101010000000102010202020302020202020302020202020302020201020100000000020002020202020202030302020203020202030302020202020202000200000000020202020202020202030303030303030202020202020202020000000202020202020202020202030101010101010103020202020202020202020200000002020202020202030101010101010101010302020202020202000000000200020202020202030101010103030301010101030202020202020002000000000202020202030101010303030203030301010103020202020200000002020202020203030301010101030202020301010101030303020202020202000000020202020203010101030303020303030101010302020202020000000002000202020202020301010101030303010101010302020202020200020000000002020202020202030101010101010101010302020202020202000000020202020202020202020203010101010101010302020202020202020202020000000202020202020202020303030303030302020202020202020200000000010001020102020202020202020202020202020202020202010201000100000000010101010201020202020202020202020202020102010101010000000101010100010101000102010202020202020201020100010101000101010100000001000100010001000101020202020201010001000100010001000000000100010101010101010101010202020202010101010101010101010001000000000100000001000001000102020202020100010000010000000100000001010101010101010101010101010202020101010101010101010101010101000000010100010001000100010102020201010001000100010001010000000001000101000100010001000101020202010100010001000100010100010000000001000100010001000100010202020100010001000100010001000000";

    bytes constant public data2 = hex"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000101000100000000000000000000000000010101000100000000000000000001010100010000000000000000000000000101000100000000000000000000010100000000000000000000000000000001000000000000000000000000000100000000000000000000000000000000010000000000000000000000000001000000000000000000000000020002000200020002000000000002000200020002000200000000000000000202020202020202020000000000020202020202020202000000000000000002020202020202020200000000000202020202020202020000000000000000000202020202020200000000000000020202020202020000000000000000000002020202020202000000000000000202020202020200000000000000000000020202020202020000000000000002020202020202000000000000000000000202020202020200000000000000020202020202020000000000030003000302020202020202000300030003000202020202020203000300030303030303020202020202020303030303030302020202020202030303030303030303030202020202020203030303030303020202020202020303030303000300000302020202020202030000030000030202020202020203000003000003000003020202020202020300000300000302020202020202030000030003030303030202020202020203030303030303020202020202020303030303030303030302020202020202030303030303030202020202020203030303030303030303020202020202020303000000030302020202020202030303030303030303030202020202020203000000000003020202020202020303030303030303030302020202020202030000000000030202020202020203030303030303030303020202020202020300000000000302020202020202030303030303030303030202020202020203000000000003020202020202020303030303";


    bytes constant public data3 = hex"00010101010101010101010101010101010101010101010101010101010100010000000000000000000000000000000000000000000000000000000000010100000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000010100000000000000000000000000010101000000000000000000000000000101000000000000000000000000010101010100000000000000000000000001010000000000000000000000010101010101010000000000000000000000010100000000000000000000010101010101010101000000000000000000000101000000000000000000010202020202020202020100000000000000000001010000000000000000000102020202020202020201000000000000000000010100000000000000000001020202020202020202010000000000000000000101000000000000000000010202020201020202020100000000000000000001010000000000000000000102020202010202020201000000000000000000010100000000000000000001000202020202020200010000000000000000000101000000000000000000000000020202020200000000000000000000000001010000000000000000000000000202020202000000000000000000000000010100000000000000000000000002020202020000000000000000000000000101000000000000000000000000000202020000000000000000000000000001010000000000000000000000000001010100000000000000000000000000010100000000000000000000000201010101010200000000000000000000000101000000000000000000000002010101010102000000000000000000000001010000000000000000000000020100010001020000000000000000000000010100000000000000000000000201010001010200000000000000000000000101000000000000000000000002010001000102000000000100000000000001010000000000000000000000020101010101020202020202000000000000010100000000000000000000000201010101010000000001010100000000000101000000000000000000000002010101010100000000000100000000000001010000000000000000000000020101010101000000000001000000000000010100000000000000000000000201010101010000000000010000000000000100010101010101010101010101010101010101010101000100010101010100";

    bytes constant public data4 = hex"00000000010000000000000100000000000001000000000000000000000000000000000002000000000002000000000002000000000000000000000000000000000000000200000000020000000002000000000000000000000000000000000000000000020000000200000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101010101000000000000000000000000000000000000000000000000000001010101010000000000000000000000000000000000010202020202020200010100010100020202020202020202020202020202010000000000000000000000000101000000000000000000000000000000000000000000000000000001010101010000000000000000000000000000000000000000000000000000010101010100000000000000000000000000000000000000000000000000000000030300000000000000000000000000000000000000000000000000000000000303000000000000000000000000000000000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000010101010101010101010100000000000000000000000000000000000000010101010101010101010101010000000000000000000000000000000000010101010101010101010101010101000000000000000000000000000000000101010101010101010101010101010000000000000000000000000000000001010101010101010101010101010100000000000000000000000000000000020101010101020101010101010102000000000000000000000000000000000301010101010301010101010101030000000000000000000000000000000003010101010103010101010101030000000000000000000000000000000000030000000000030000000000030000000000000000000000000000000000000300000000000300000000030000000000000000000000000000000000030300000000030300000000000003030000000000000000020202020202020202020202020202020202020202020202020202020202020200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002";

    bytes constant public data5 = hex"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010100000000000000000000000000000001010100000000000000000000010101000000000000000000000000000000010101010000000000000000010101010000000000000000000000000000010101010100000000000000000101010100000000000000000000000000000101010101000000000000000001010101000000000000000000000000000001010201010100000000000001010101010000000000000000000000000000010102010101000000000000010102010100000000000000000000000000010101000201010000000000010101020101000000000000000000000000000101010002010100000000000101020001010000000000000000000000000001010200030202000000000101010200010100000000000000000000000000010102000302020000000001010100000101010000000000000000000000010101030003030300000001010102000001010100000000000000000000000101010300000303000000010101020000020101000000000000000000000101010203000003030000010101020300000201010000000000010101010001010102000000030301010101010203000003010100000000000101010101010102030000000303010101010203030000030101000000000101010101010101020000000003030101010202000300000301010000000101010202010101020300000000000302020202030003000000010100000001010102020202020203000000000003020202030300030000000101010001010102030302020203000000000000030303030303000300000001010101010101020303030303030000000000000303030300030003000000020101010101020300000303030000000000000003000300000300000000000201010101020203000000000000000000000000030003000003000000000003020101020203030000000000000000000000000300030000030000000000030202020203030000000000000000000000000003000300000300000000000303020203030300000000000000000000000000030000000003000000000000030303030300000000000000000000000000000300000000030000000000000303030300000000000000000000000000000003";

    bytes constant public data6 = hex"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101010101000000000000000000000000000000000000000000000000010101020202010101000000000000000000000000000000000000000001010102020303030202010101000000000000000000000000000000000001020202030303030303030202020100000000000000000000000000000001020203030303030303030303030202010000000000000000000000000000010203030303030303030303030303020100000000000000000000000000010102030303030303030303030303030201010000000000000000000000000102020303030303030303030303030302020100000000000000000000000102020303030303030303030303030303030202010000000000000000000001020303030303030101010101030303030303020100000000000000000000010203030303020101010101010101030303030201000000000000000000000102030303020101030303030302010103030302010000000000000000000001020303020101030302020203030201010303020100000000000000000000010203020101030302020202020303020101030201000000000000000000000102030201030302020202020202030302010302010000000000000000000001020302010302020202020202020203020103020100000000000000000000010203020103020202020202020202030303030201000000000000000000000102030303030202020202020202020302010302010000000000000000000001020302010302020202020202020203020103020100000000000000000000010203030303020202020202020202030201030201000000000000000000000102030201030202020202020202020302010302010000000000000000000001020302010302020202020202020203020103020100000000000000000000010203020103020202020202020202030201030201000000000000000000000102030201030200020202020200020303030302010000000000000000000001020303030302010202020202010203030203020100000000000000000000010203020103020102020202020102030201030201000000000000000000000102030201030201020202020201020302010302010000000000";

    bytes constant public data7 = hex"00000000000000000000000000000000000000000000000000000000000000010100000000000101000000010101000101010000000101000000000001010101010000000202010001010102010001020101010001020200000001010102010100000002010100010201020000000201020100010102000000010102020202000000020000000002020200000002020200000000020000000202020000020002020200000000000200000000000200000000000202020002000000000200020000000000000202000000000002020000000000000200020000000002020202020200000002000000000000000200000002020202020200000000000000000002000000020000000000000002000000020000000000000000000000000000000202020000000000000000000202020000000000000000000000000000000000020000000000000000000000020000000000000000000000010000000000000202020200000000000202020200000000000001000000010102020202020200000002000000000002000000020202020202010100010102020000000000000000020000000000020000000000000000020201010001010000000000000000000202020002020200000000000000000001010000000100000000000000000000000202020000000000000000000000010000000000000000000000000000000002020200000000000000000000000000000000000003000300000003000000020202000000030000000300030000000003000300030003000300030003000202020003000300030003000300030003030303030303030303030303030302020203030303030303030303030303030303020202020202020202020202020302020202020202020202020202030302020203030302030303030302030203020302030303030302030303020202030303030303020303030202020302030203020202030303020303030303030202020203020203030302030303020302030303020303030202030202020203030302020203030202020303020203020203030202020303020202030303020203030303030202030203030203030302030302030202030303030302020302020202020303030302030202030302020203020303030302020202020303030303030203030202020302030303020302030202020303020303030303030303020202020202030303020303020203020303030202020202020303030202020203030302030303020203020203030202030303020303030202020203030303030302020303030203030203030303020303030202030303030303";

    address public owner;
    uint256 public publicCount;
    uint256 public chosenCount;
    bool public enabled;
    mapping (uint256 => uint256) variationMap;

    string[] private chars1;
    string[] private chars2;
    string[] private chars3;
    string[] private chars4;

    ICorruptionsPaletteToCharacterHelper private helper = ICorruptionsPaletteToCharacterHelper(0x358aaEfCFD6447C8795862586707a61fa4b330A1);
    
    constructor() {
        owner = msg.sender;
        enabled = false;

        chars1.push("&#x000A0;");
        chars1.push("&#x0007C;");
        chars1.push("&#x02592;");
        chars1.push("&#x02591;");

        chars2.push("&#x000A0;");
        chars2.push("&#x02593;");
        chars2.push("&#x02592;");
        chars2.push("&#x02591;");

        chars3.push("&#x0259E;");
        chars3.push("&#x0007C;");
        chars3.push("&#x02592;");
        chars3.push("&#x02591;");

        chars4.push("&#x025c8;");
        chars4.push("&#x02593;");
        chars4.push("&#x02592;");
        chars4.push("&#x02591;");
    }
    
    function setEnabled(bool isEnabled) public {
        require(msg.sender == owner, "Writer: not owner");
        enabled = isEnabled;
    }
    
    function DEVIATE___CORRUPTION_WILL_BE_LOCKED_PERMANENTLY_AND_NO_LONGER_GAIN_INSIGHT(uint256 tokenId, string memory ack) public {
        // Deviated corruptions render differently but are *permanently* destabilized and will no longer gain insight
        //
        // This is OPTIONAL
        // This is PERMANENT
        // This is IRREVERSIBLE
        // This is NOT A PUZZLE PIECE OR KEY
        //
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        // THERE IS NOTHING THAT COMES AFTER A CORRUPTION DEVIATES
        
        require(enabled || msg.sender == owner, "Writer: not enabled");

        // I_HAVE_READ_THE_DISCLAIMER_AND_ACKNOWLEDGE
        require(keccak256(bytes(ack)) == bytes32(hex"98f083d894dad4ec49f86c8deae933e9e51a46d20f726170c3460fa6c80077f4"), "Writer: not acknowledged");
        require(ICorruptions(0x5BDf397bB2912859Dbd8011F320a222f79A28d2E).ownerOf(tokenId) == msg.sender, "Writer: corruption not owned");
        require(ICorruptionsDataMapper(0x7A96d95a787524a27a4df36b64a96910a2fDCF5B).valueFor(0, tokenId) == 0, "Writer: already inscribed");
        require(ICorruptions(0x5BDf397bB2912859Dbd8011F320a222f79A28d2E).insight(tokenId) >= 10, "Writer: insight too low");

        uint256 variation;
        if (msg.sender != chosenAddress) {
            require(publicCount < 504, "Writer: no remaining inscriptions");
            variation = publicCount % 8;
            publicCount++;
        } else {
            require(chosenCount < 8, "Writer: no remaining chosen inscriptions");
            variation = chosenCount;
            chosenCount++;
        }
        
        variationMap[tokenId] = variation;
        ICorruptionsDataMapper(0x7A96d95a787524a27a4df36b64a96910a2fDCF5B).setValue(0, tokenId, variation + 2);
    }

    function drawCanvas(uint256 tokenId, uint256 amount) public view returns (string[32] memory) {
        tokenId; // unused
        amount; // unused

        bytes memory data;
        string[] memory chars;

        if (variationMap[tokenId] == 0) {
            data = data0;
        } else if (variationMap[tokenId] == 1) {
            data = data1;
        } else if (variationMap[tokenId] == 2) {
            data = data2;
        } else if (variationMap[tokenId] == 3) {
            data = data3;
        } else if (variationMap[tokenId] == 4) {
            data = data4;
        } else if (variationMap[tokenId] == 5) {
            data = data5;
        } else if (variationMap[tokenId] == 6) {
            data = data6;
        } else if (variationMap[tokenId] == 7) {
            data = data7;
        }

        uint256 num = uint256(keccak256(abi.encodePacked("V", tokenId, variationMap[tokenId])));

        if (num % 4 == 0) {
            chars = chars1;
        } else if (num % 4 == 1) {
            chars = chars2;
        } else if (num % 4 == 2) {
            chars = chars3;
        } else {
            chars = chars4;
        }

        string[32] memory canvas = helper.prepareCanvas(chars, 4, data);
        return canvas;
    }
}
