{"status":"1","message":"OK","result":[{"SourceCode":"pragma solidity 0.5.11;\r\n\r\n/**\r\n * @title Gods Unchained - The Chosen One\r\n * @author Mythic Titan\r\n */\r\ncontract TheChosenOne {\r\n    // 5 Gods Unchained Cards enter the arena\r\n    // The Chosen One is selected at random to keep all of the cards\r\n\r\n    // ==== EVENTS ==== //\r\n\r\n    /**\r\n     * @dev OnPlayerEnter emits an event when a player enters an arena\r\n     *\r\n     * @param _player - The player's address\r\n     * @param _quality - Gods Unchained card quality\r\n     * @param _proto - Gods Unchained proto id\r\n     */\r\n    event OnPlayerEnter(\r\n        address _player,\r\n        uint8 indexed _quality,\r\n        uint16 indexed _proto\r\n    );\r\n\r\n    /**\r\n     * @dev OnPlayerExit emits an event when a player leaves an arena\r\n     *\r\n     * @param _player - The player's address\r\n     * @param _quality - Gods Unchained card quality\r\n     * @param _proto - Gods Unchained proto id\r\n     */\r\n    event OnPlayerExit(\r\n        address _player,\r\n        uint8 indexed _quality,\r\n        uint16 indexed _proto\r\n    );\r\n\r\n    /**\r\n     * @dev OnChosenOneSelected emits an event when The Chosen One is selected\r\n     *\r\n     * @param _chosenOne - The Chosen One's address\r\n     * @param _quality - Gods Unchained card quality\r\n     * @param _proto - Gods Unchained proto id\r\n     */\r\n    event OnChosenOneSelected(\r\n        address indexed _chosenOne,\r\n        uint8 indexed _quality,\r\n        uint16 indexed _proto\r\n    );\r\n\r\n    // ==== STRUCT ==== //\r\n    struct Player {\r\n        uint256 tokenId;\r\n        address owner;\r\n    }\r\n\r\n    // ==== PUBLIC VARIABLES ==== //\r\n\r\n    // Mapping proto to quality to players\r\n    mapping(uint16 => mapping(uint8 => Player[])) public arenas;\r\n\r\n    /**\r\n     * @dev quorum is how many players must be in an arena to select The Chosen One\r\n     */\r\n    uint256 public quorum = 5;\r\n\r\n    /**\r\n     * @dev tokenAddress is the ERC721 Token address\r\n     */\r\n    address public tokenAddress;\r\n\r\n    /**\r\n     * @dev tokenInterface interfaces with the ERC721\r\n     */\r\n    interfaceERC721 public tokenInterface;\r\n\r\n    // ==== CONSTRUCTOR ==== //\r\n\r\n    /**\r\n     * @dev constructor runs once during contract deployment\r\n     *\r\n     * @param _tokenAddress - The Gods Unchained contract address\r\n     */\r\n    constructor(address _tokenAddress)\r\n        public\r\n    {\r\n        tokenInterface = interfaceERC721(_tokenAddress);\r\n    }\r\n\r\n    // ==== MODIFIERS ==== //\r\n\r\n    /**\r\n     * @dev onlyEOA requires msg.sender to be an externally owned account\r\n     */\r\n    modifier onlyEOA() {\r\n        require(msg.sender == tx.origin, \"only externally owned accounts\");\r\n        _;\r\n    }\r\n\r\n    // ==== PUBLIC WRITE FUNCTIONS ==== //\r\n\r\n    /**\r\n     * @dev activateArena selects The Chosen One\r\n     *\r\n     * @param proto - Gods Unchained Proto ID\r\n     * @param quality - Gods Unchained Quality\r\n     */\r\n    function activateArena(uint16 proto, uint8 quality)\r\n        public\r\n        onlyEOA\r\n    {\r\n        // Reference the players\r\n        Player[] storage players = arenas[proto][quality];\r\n\r\n        // Require minimum number of players before selecting The Chosen One\r\n        require(players.length == quorum, \"requires minimum number of players\");\r\n\r\n        // Select The Chosen One at random\r\n        uint256 random = getRandom(quorum, proto, quality);\r\n\r\n        // The Chosen One\r\n        address theChosenOne = players[random].owner;\r\n\r\n        // Transfer winning cards to The Chosen One and Reset the players\r\n        for(uint256 i = players.length - 1; i >= 0; i--) {\r\n            tokenInterface.transferFrom(address(this), theChosenOne, players[i].tokenId);\r\n            players.pop();\r\n        }\r\n\r\n        // Emit an event log when The Chosen One is selected\r\n        emit OnChosenOneSelected(theChosenOne, quality, proto);\r\n    }\r\n\r\n    /**\r\n     * @dev exitArena removes a player from an Arena\r\n     *\r\n     * @param proto - Gods Unchained proto\r\n     * @param quality - Gods Unchained quality\r\n     * @param index - Index of the player to remove\r\n     */\r\n    function exitArena(uint16 proto, uint8 quality, uint256 index)\r\n        private\r\n    {\r\n        // Reference the players\r\n        Player[] storage arena = arenas[proto][quality];\r\n\r\n        // Require the msg.sender is the player\r\n        require(arena[index].owner == msg.sender, \"Must be the player\");\r\n\r\n        // Store the token id\r\n        uint256 tokenId = arena[index].tokenId;\r\n\r\n        // Set the last index equal to the removed player\r\n        arena[index] = arena[arena.length - 1];\r\n\r\n        // Remove last element in the list of players\r\n        arena.pop();\r\n\r\n        // Transfer the token back to the owner\r\n        tokenInterface.transferFrom(address(this), msg.sender, tokenId);\r\n\r\n        // Emit an event when a player leaves an arena\r\n        emit OnPlayerExit(msg.sender, quality, proto);\r\n    }\r\n\r\n    // ==== EXTERNAL FUNCTIONS ==== //\r\n\r\n    /**\r\n     * @dev onERC721Received handles receiving an ERC721 token\r\n     *\r\n     * _operator - The address which called `safeTransferFrom` function\r\n     * @param _from - The address which previously owned the token\r\n     * @param _tokenId - The NFT IDentifier which is being transferred\r\n     * _data - Additional data with no specified format\r\n     *\r\n     * @return Receipt\r\n     */\r\n    function onERC721Received(address /*_operator*/, address _from, uint256 _tokenId, bytes calldata /*_data*/)\r\n        external\r\n        returns(bytes4)\r\n    {\r\n        // Require token address is authorized\r\n        require(msg.sender == tokenAddress, \"must be the token address\");\r\n\r\n        // Require token holder is an externally owned account\r\n        require(tx.origin == _from, \"token owner must be an externally owned account\");\r\n\r\n        // Get the Gods Unchained Proto and Quality from Token ID\r\n        (uint16 proto, uint8 quality) = tokenInterface.getDetails(_tokenId);\r\n\r\n        // Check if there is space for a player in the arena\r\n        require(arenas[proto][quality].length < quorum, \"Max Players Reached\");\r\n\r\n        // Add player to an arena\r\n        arenas[proto][quality].push(Player({\r\n            tokenId: _tokenId,\r\n            owner: _from\r\n        }));\r\n\r\n        // Emit event when a new player enters the arena\r\n        emit OnPlayerEnter(_from, quality, proto);\r\n\r\n        // ERC721_RECEIVED Receipt (magic value)\r\n        return 0x150b7a02;\r\n    }\r\n\r\n    // ==== PRIVATE FUNCTIONS ==== //\r\n\r\n    /**\r\n     * @dev getRandom generates a random integer from 0 to (max - 1)\r\n     *\r\n     * @param max - Maximum number of integers to select from\r\n     * @param proto - Gods Unchained Proto\r\n     * @param quality - Gods Unchained Quality\r\n     * @return random - The randomly selected integer\r\n     */\r\n    function getRandom(uint256 max, uint16 proto, uint8 quality)\r\n        private\r\n        view\r\n        returns(uint256 random)\r\n    {\r\n        // Blockhash from last block\r\n        uint256 blockhash_ = uint256(blockhash(block.number - 1));\r\n\r\n        // Randomly generated integer\r\n        random = uint256(keccak256(abi.encodePacked(\r\n            // Unix timestamp in seconds\r\n            block.timestamp,\r\n            // Address of the block miner\r\n            block.coinbase,\r\n            // Difficulty of the block\r\n            block.difficulty,\r\n            // Blockhash from last block\r\n            blockhash_,\r\n            // Proto\r\n            proto,\r\n            // Quality\r\n            quality\r\n        ))) % max;\r\n    }\r\n}\r\n\r\n// ==== INTERFACE ==== //\r\n/**\r\n * @title Abstract Contract Interface\r\n */\r\ncontract interfaceERC721 {\r\n    function getDetails(uint256 _tokenId) public view returns (uint16, uint8);\r\n    function transferFrom(address from, address to, uint256 tokenId) public;\r\n}","ABI":"[{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"_from\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"_tokenId\",\"type\":\"uint256\"},{\"internalType\":\"bytes\",\"name\":\"\",\"type\":\"bytes\"}],\"name\":\"onERC721Received\",\"outputs\":[{\"internalType\":\"bytes4\",\"name\":\"\",\"type\":\"bytes4\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"quorum\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint16\",\"name\":\"proto\",\"type\":\"uint16\"},{\"internalType\":\"uint8\",\"name\":\"quality\",\"type\":\"uint8\"}],\"name\":\"activateArena\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"internalType\":\"uint16\",\"name\":\"\",\"type\":\"uint16\"},{\"internalType\":\"uint8\",\"name\":\"\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"arenas\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"tokenAddress\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"tokenInterface\",\"outputs\":[{\"internalType\":\"contract interfaceERC721\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_tokenAddress\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"_player\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint8\",\"name\":\"_quality\",\"type\":\"uint8\"},{\"indexed\":true,\"internalType\":\"uint16\",\"name\":\"_proto\",\"type\":\"uint16\"}],\"name\":\"OnPlayerEnter\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"_player\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint8\",\"name\":\"_quality\",\"type\":\"uint8\"},{\"indexed\":true,\"internalType\":\"uint16\",\"name\":\"_proto\",\"type\":\"uint16\"}],\"name\":\"OnPlayerExit\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"_chosenOne\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint8\",\"name\":\"_quality\",\"type\":\"uint8\"},{\"indexed\":true,\"internalType\":\"uint16\",\"name\":\"_proto\",\"type\":\"uint16\"}],\"name\":\"OnChosenOneSelected\",\"type\":\"event\"}]","ContractName":"TheChosenOne","CompilerVersion":"v0.5.11+commit.c082d0b4","OptimizationUsed":"1","Runs":"200","ConstructorArguments":"0000000000000000000000000e3a2a1f2146d86a604adc220b4967a898d7fe07","Library":"","LicenseType":"MIT","SwarmSource":"bzzr://ab85f79eca366646e02fc441c0493864873e42e8f3df42c569ca30484dfdd507"}]}