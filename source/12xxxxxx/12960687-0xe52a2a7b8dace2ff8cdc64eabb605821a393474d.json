{"status":"1","message":"OK","result":[{"SourceCode":"// SPDX-License-Identifier: UNLICENSED\r\npragma solidity 0.8.2;\r\n\r\ninterface IArtBlocksFactory {\r\n\tfunction tokenIdToProjectId(uint256 _tokenId) external view returns (uint256 projectId);\r\n\tfunction safeTransferFrom(address from, address to, uint256 tokenId) external;\r\n}\r\n\r\ncontract ArtBlocksBroker {\r\n\tIArtBlocksFactory public constant ARTBLOCKS_FACTORY = IArtBlocksFactory(0xa7d8d9ef8D8Ce8992Df33D8b8CF4Aebabd5bD270);\r\n\r\n\tstruct Order {\r\n\t\tuint128 priceInWeiEach;\r\n\t\tuint128 quantity;\r\n\t}\r\n\r\n\t// user => projectID => Order\r\n\tmapping(address => mapping(uint256 => Order)) public orders;\r\n\tmapping(address => uint256) public balances; // for bots\r\n\r\n\taddress public coordinator;\r\n\taddress public profitReceiver;\r\n\tuint256 public artBlocksBrokerFeeBips; // paid by bots, not users\r\n\r\n\tmodifier onlyCoordinator() {\r\n\t\trequire(msg.sender == coordinator, 'not Coordinator');\r\n\t\t_;\r\n\t}\r\n\r\n\tevent Action(address indexed _user, uint256 indexed _artBlocksProjectId, uint256 _priceInWeiEach, uint256 _quantity, string _action, uint256 _optionalTokenId);\r\n\r\n\tconstructor(address _profitReceiver , uint256 _artBlocksBrokerFeeBips) {\r\n\t\tcoordinator = msg.sender;\r\n\t\tprofitReceiver = _profitReceiver;\r\n\t\trequire(_artBlocksBrokerFeeBips < 10_000, 'fee too high');\r\n\t\tartBlocksBrokerFeeBips = _artBlocksBrokerFeeBips;\r\n\t}\r\n\r\n\t// **************\r\n\t// USER FUNCTIONS\r\n\t// **************\r\n\r\n\tfunction placeOrder(uint256 _artBlocksProjectId, uint128 _quantity) external payable {\r\n\t\t// CHECKS\r\n\t\trequire(_artBlocksProjectId != 0, 'invalid AB id');\r\n\t\trequire(msg.sender == tx.origin, 'we only mint to EOAs'); // removes user foot-guns and garuantees user can receive NFTs\r\n\t\tOrder memory order = orders[msg.sender][_artBlocksProjectId];\r\n\t\trequire(order.priceInWeiEach * order.quantity == 0, 'You already have an order for this ArtBlocks project. Please cancel the existing order before making a new one.');\r\n\t\tuint128 priceInWeiEach = uint128(msg.value) / _quantity;\r\n\t\trequire(priceInWeiEach > 0, 'Zero wei offers not accepted.');\r\n\r\n\t\t// EFFECTS\r\n\t\torders[msg.sender][_artBlocksProjectId].priceInWeiEach = priceInWeiEach;\r\n\t\torders[msg.sender][_artBlocksProjectId].quantity = _quantity;\r\n\r\n\t\temit Action(msg.sender, _artBlocksProjectId, priceInWeiEach, _quantity, 'order placed', 0);\r\n\t}\r\n\r\n\tfunction cancelOrder(uint256 _artBlocksProjectId) external {\r\n\t\t// CHECKS\r\n\t\tOrder memory order = orders[msg.sender][_artBlocksProjectId];\r\n\t\tuint256 amountToSendBack = order.priceInWeiEach * order.quantity;\r\n\t\trequire(amountToSendBack != 0, 'You do not have an existing order for this ArtBlocks project.');\r\n\r\n\t\t// EFFECTS\r\n\t\tdelete orders[msg.sender][_artBlocksProjectId];\r\n\r\n\t\t// INTERACTIONS\r\n\t\tsendValue(payable(msg.sender), amountToSendBack);\r\n\r\n\t\temit Action(msg.sender, _artBlocksProjectId, 0, 0, 'order cancelled', 0);\r\n\t}\r\n\r\n\t// *************\r\n\t// BOT FUNCTIONS\r\n\t// *************\r\n\r\n\tfunction fulfillOrder(address _user, uint256 _artBlocksProjectId, uint256 _tokenId, uint256 _expectedPriceInWeiEach, address _profitTo, bool _sendNow) public returns (uint256) {\r\n\t\t// CHECKS\r\n\t\tOrder memory order = orders[_user][_artBlocksProjectId];\r\n\t\trequire(order.quantity > 0, 'user order DNE');\r\n\t\trequire(order.priceInWeiEach >= _expectedPriceInWeiEach, 'user offer insufficient'); // protects bots from users frontrunning them\r\n\t\trequire(ARTBLOCKS_FACTORY.tokenIdToProjectId(_tokenId) == _artBlocksProjectId, 'user did not request this NFT');\r\n\r\n\t\t// EFFECTS\r\n\t\tOrder memory newOrder;\r\n\t\tif (order.quantity > 1) {\r\n\t\t\tnewOrder.priceInWeiEach = order.priceInWeiEach;\r\n\t\t\tnewOrder.quantity = order.quantity - 1;\r\n\t\t}\r\n\t\torders[_user][_artBlocksProjectId] = newOrder;\r\n\r\n\t\tuint256 artBlocksBrokerFee = order.priceInWeiEach * artBlocksBrokerFeeBips / 10_000;\r\n\t\tbalances[profitReceiver] += artBlocksBrokerFee;\r\n\r\n\t\t// INTERACTIONS\r\n\t\t// transfer NFT to user\r\n\t\tARTBLOCKS_FACTORY.safeTransferFrom(msg.sender, _user, _tokenId); // reverts on failure\r\n\r\n\t\t// pay the fullfiller\r\n\t\tif (_sendNow) {\r\n\t\t\tsendValue(payable(_profitTo), order.priceInWeiEach - artBlocksBrokerFee);\r\n\t\t} else {\r\n\t\t\tbalances[_profitTo] += order.priceInWeiEach - artBlocksBrokerFee;\r\n\t\t}\r\n\r\n\t\temit Action(_user, _artBlocksProjectId, newOrder.priceInWeiEach, newOrder.quantity, 'order fulfilled', _tokenId);\r\n\r\n\t\treturn order.priceInWeiEach - artBlocksBrokerFee; // proceeds to order fullfiller\r\n\t}\r\n\r\n\tfunction fulfillMultipleOrders(address[] memory _user, uint256[] memory _artBlocksProjectId, uint256[] memory _tokenId, uint256[] memory _expectedPriceInWeiEach, address[] memory _profitTo, bool[] memory _sendNow) external returns (uint256[] memory) {\r\n\t\tuint256[] memory output = new uint256[](_user.length);\r\n\t\tfor (uint256 i = 0; i < _user.length; i++) {\r\n\t\t\toutput[i] = fulfillOrder(_user[i], _artBlocksProjectId[i], _tokenId[i], _expectedPriceInWeiEach[i], _profitTo[i], _sendNow[i]);\r\n\t\t}\r\n\t\treturn output;\r\n\t}\r\n\r\n\t// *********************\r\n\t// COORDINATOR FUNCTIONS\r\n\t// *********************\r\n\r\n\tfunction changeCoordinator(address _newCoordinator) external onlyCoordinator {\r\n\t\tcoordinator = _newCoordinator;\r\n\t}\r\n\r\n\tfunction changeProfitReceiver(address _newProfitReceiver) external onlyCoordinator {\r\n\t\tprofitReceiver = _newProfitReceiver;\r\n\t}\r\n\r\n\tfunction changeArtBlocksBrokerFeeBips(uint256 _newArtBlocksBrokerFeeBips) external onlyCoordinator {\r\n\t\trequire(_newArtBlocksBrokerFeeBips < artBlocksBrokerFeeBips, 'fee can only ever be reduced');\r\n\t\tartBlocksBrokerFeeBips = _newArtBlocksBrokerFeeBips;\r\n\t}\r\n\r\n\t// ******************\r\n\t// WITHDRAW FUNCTIONS\r\n\t// ******************\r\n\r\n\t// for profitReceiver and bots\r\n\tfunction withdraw() external {\r\n\t\tuint256 amount = balances[msg.sender];\r\n\t\tdelete balances[msg.sender];\r\n\t\tsendValue(payable(msg.sender), amount);\r\n\t}\r\n\r\n\t// ****************\r\n\t// HELPER FUNCTIONS\r\n\t// ****************\r\n\r\n\t// OpenZeppelin's sendValue function, used for transfering ETH out of this contract\r\n\tfunction sendValue(address payable recipient, uint256 amount) internal {\r\n\t\trequire(address(this).balance >= amount, \"Address: insufficient balance\");\r\n\t\t// solhint-disable-next-line avoid-low-level-calls, avoid-call-value\r\n\t\t(bool success, ) = recipient.call{ value: amount }(\"\");\r\n\t\trequire(success, \"Address: unable to send value, recipient may have reverted\");\r\n\t}\r\n\r\n\tfunction viewOrder(address _user, uint256 _artBlocksProjectId) external view returns (Order memory) {\r\n\t\treturn orders[_user][_artBlocksProjectId];\r\n\t}\r\n\r\n\tfunction viewOrders(address[] memory _users, uint256[] memory _artBlocksProjectIds) external view returns (Order[] memory) {\r\n\t\tOrder[] memory output = new Order[](_users.length);\r\n\t\tfor (uint256 i = 0; i < _users.length; i++) output[i] = orders[_users[i]][_artBlocksProjectIds[i]];\r\n\t\treturn output;\r\n\t}\r\n}","ABI":"[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_profitReceiver\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"_artBlocksBrokerFeeBips\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"_user\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"_priceInWeiEach\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"_quantity\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"_action\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"_optionalTokenId\",\"type\":\"uint256\"}],\"name\":\"Action\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"ARTBLOCKS_FACTORY\",\"outputs\":[{\"internalType\":\"contract IArtBlocksFactory\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"artBlocksBrokerFeeBips\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"balances\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256\"}],\"name\":\"cancelOrder\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_newArtBlocksBrokerFeeBips\",\"type\":\"uint256\"}],\"name\":\"changeArtBlocksBrokerFeeBips\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_newCoordinator\",\"type\":\"address\"}],\"name\":\"changeCoordinator\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_newProfitReceiver\",\"type\":\"address\"}],\"name\":\"changeProfitReceiver\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"coordinator\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address[]\",\"name\":\"_user\",\"type\":\"address[]\"},{\"internalType\":\"uint256[]\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256[]\"},{\"internalType\":\"uint256[]\",\"name\":\"_tokenId\",\"type\":\"uint256[]\"},{\"internalType\":\"uint256[]\",\"name\":\"_expectedPriceInWeiEach\",\"type\":\"uint256[]\"},{\"internalType\":\"address[]\",\"name\":\"_profitTo\",\"type\":\"address[]\"},{\"internalType\":\"bool[]\",\"name\":\"_sendNow\",\"type\":\"bool[]\"}],\"name\":\"fulfillMultipleOrders\",\"outputs\":[{\"internalType\":\"uint256[]\",\"name\":\"\",\"type\":\"uint256[]\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_user\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"_tokenId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"_expectedPriceInWeiEach\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"_profitTo\",\"type\":\"address\"},{\"internalType\":\"bool\",\"name\":\"_sendNow\",\"type\":\"bool\"}],\"name\":\"fulfillOrder\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"orders\",\"outputs\":[{\"internalType\":\"uint128\",\"name\":\"priceInWeiEach\",\"type\":\"uint128\"},{\"internalType\":\"uint128\",\"name\":\"quantity\",\"type\":\"uint128\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256\"},{\"internalType\":\"uint128\",\"name\":\"_quantity\",\"type\":\"uint128\"}],\"name\":\"placeOrder\",\"outputs\":[],\"stateMutability\":\"payable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"profitReceiver\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_user\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"_artBlocksProjectId\",\"type\":\"uint256\"}],\"name\":\"viewOrder\",\"outputs\":[{\"components\":[{\"internalType\":\"uint128\",\"name\":\"priceInWeiEach\",\"type\":\"uint128\"},{\"internalType\":\"uint128\",\"name\":\"quantity\",\"type\":\"uint128\"}],\"internalType\":\"struct ArtBlocksBroker.Order\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address[]\",\"name\":\"_users\",\"type\":\"address[]\"},{\"internalType\":\"uint256[]\",\"name\":\"_artBlocksProjectIds\",\"type\":\"uint256[]\"}],\"name\":\"viewOrders\",\"outputs\":[{\"components\":[{\"internalType\":\"uint128\",\"name\":\"priceInWeiEach\",\"type\":\"uint128\"},{\"internalType\":\"uint128\",\"name\":\"quantity\",\"type\":\"uint128\"}],\"internalType\":\"struct ArtBlocksBroker.Order[]\",\"name\":\"\",\"type\":\"tuple[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"withdraw\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]","ContractName":"ArtBlocksBroker","CompilerVersion":"v0.8.2+commit.661d1103","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"000000000000000000000000c87f98bc399fd19f86affae85d80e150ce92f17000000000000000000000000000000000000000000000000000000000000007d0","EVMVersion":"Default","Library":"","LicenseType":"Unlicense","Proxy":"0","Implementation":"","SwarmSource":"ipfs://c883a2fb3ded9cfe1cb51ea4b800b58ebc19f50dcf0ec1577495c68bf3f6d2ea"}]}