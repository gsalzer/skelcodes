{"status":"1","message":"OK","result":[{"SourceCode":"pragma solidity ^0.4.24;\r\n\r\ncontract WaRoll {\r\n\r\n    struct BetData {\r\n        uint gameId;\r\n        address player;\r\n        uint amount;\r\n        uint value;\r\n        uint blockNum;\r\n        bytes betData;\r\n    }\r\n\r\n    uint constant private FEE_PERCENT = 1;\r\n    uint constant private MIN_FEE = 0.0003 ether;\r\n\r\n    uint constant private MIN_STAKE = 0.001 ether;\r\n    uint constant private MAX_STAKE = 10 ether;\r\n\r\n    uint constant private ROULETTE_BASE_STAKE = 0.01 ether;\r\n\r\n    uint constant private TYPE_ROLL = 0;\r\n    uint constant private TYPE_ROULETTE = 1;\r\n    uint constant private ROLL_MAX_MOD = 100;\r\n    uint constant private ROULETTE_MAX_MOD = 37;\r\n\r\n    mapping(bytes32 => BetData) private bets;\r\n\r\n    address private owner;\r\n    address private signer;\r\n    address public croupier;\r\n\r\n    event BetEvent(uint gamdId, bytes32 commit, bytes data);\r\n    event RollPayment(address player, uint gameId, uint payAmount, uint value, uint result, uint betAmount, uint betValue, bytes32 betTx);\r\n    event RoulettePayment(address player, uint gameId, uint payAmount, uint value, uint result, uint betAmount, bytes32 betTx, bytes betData);\r\n    event PaymentFail(address player, uint amount);\r\n\r\n    constructor() public payable {\r\n        owner = msg.sender;\r\n        signer = msg.sender;\r\n        croupier = msg.sender;\r\n    }\r\n\r\n    modifier ownerOnly(){\r\n        require(msg.sender == owner, \"not owner\");\r\n        _;\r\n    }\r\n\r\n    modifier croupierOnly(){\r\n        require(msg.sender == croupier, \"not croupier\");\r\n        _;\r\n    }\r\n\r\n    modifier validSignAndBlock(uint blockNum, bytes32 commit, bytes32 r, bytes32 s){\r\n        require(blockNum >= block.number, \"commit has expired\");\r\n        bytes32 v1 = keccak256(abi.encodePacked(uint40(blockNum), commit));\r\n        require(signer == ecrecover(v1, 27, r, s) || signer == ecrecover(v1, 28, r, s), \"signer valid error\");\r\n        _;\r\n    }\r\n\r\n    function setCroupier(address c) public ownerOnly {\r\n        croupier = c;\r\n    }\r\n\r\n    function setSigner(address c) public ownerOnly {\r\n        signer = c;\r\n    }\r\n\r\n\r\n    function kill() public ownerOnly {\r\n        selfdestruct(owner);\r\n    }\r\n\r\n    function doRollBet(uint value, uint expiredBlockNum, bytes32 commit, bytes32 r, bytes32 s) public payable validSignAndBlock(expiredBlockNum, commit, r, s) {\r\n        require(value >= 1 && value <= ROLL_MAX_MOD - 3, \"invalid value\");\r\n        uint stake = msg.value;\r\n        require(stake >= MIN_STAKE && stake <= MAX_STAKE);\r\n        BetData storage bet = bets[commit];\r\n        require(bet.player == address(0));\r\n        bet.gameId = TYPE_ROLL;\r\n        bet.value = value;\r\n        bet.amount = stake;\r\n        bet.player = msg.sender;\r\n        bet.blockNum = block.number;\r\n        emit BetEvent(bet.gameId, commit, new bytes(0));\r\n    }\r\n\r\n    function doRouletteBet(bytes data, uint expiredBlockNum, bytes32 commit, bytes32 r, bytes32 s) public payable validSignAndBlock(expiredBlockNum, commit, r, s) {\r\n        uint stake = msg.value;\r\n        validRouletteBetData(data, stake);\r\n        BetData storage bet = bets[commit];\r\n        require(bet.player == address(0));\r\n        bet.gameId = TYPE_ROULETTE;\r\n        bet.betData = data;\r\n        bet.amount = stake;\r\n        bet.player = msg.sender;\r\n        bet.blockNum = block.number;\r\n        emit BetEvent(bet.gameId, commit, data);\r\n    }\r\n\r\n    function validRouletteBetData(bytes data, uint amount) pure private {\r\n        uint length = uint8(data[0]);\r\n        require(data.length == length * 2 + 1);\r\n        uint total = 0;\r\n        for (uint i = 0; i < length; i ++) {\r\n            total += uint8(data[2 + i * 2]);\r\n        }\r\n        require(total * ROULETTE_BASE_STAKE == amount);\r\n    }\r\n\r\n    function doResult(uint value, bytes32 blockHash, bytes32 betTx, uint paymentMutiplier) public croupierOnly payable {\r\n        bytes32 commit = keccak256(abi.encodePacked(value));\r\n        BetData storage bet = bets[commit];\r\n        require(blockhash(bet.blockNum) == blockHash);\r\n        if (bet.gameId == TYPE_ROLL) {\r\n            doRollResult(value, bet, betTx);\r\n        } else if (bet.gameId == TYPE_ROULETTE) {\r\n            doRouletteResult(value, bet, betTx, paymentMutiplier);\r\n        }\r\n    }\r\n\r\n    function doRollResult(uint value, BetData bet, bytes32 betTx) private croupierOnly {\r\n        uint result = (value % ROLL_MAX_MOD) + 1;\r\n        uint betAmount = bet.amount;\r\n        uint payAmount = 0;\r\n        if (result <= bet.value) {\r\n            uint fee = betAmount / 100 * FEE_PERCENT;\r\n            if (fee < MIN_FEE) {\r\n                fee = MIN_FEE;\r\n            }\r\n            payAmount = (betAmount - fee) * ROLL_MAX_MOD / bet.value;\r\n        }\r\n        if (bet.player.send(payAmount)) {\r\n            emit RollPayment(bet.player, bet.gameId, payAmount, value, result, bet.amount, bet.value, betTx);\r\n        } else {\r\n            emit PaymentFail(bet.player, payAmount);\r\n        }\r\n    }\r\n\r\n    function doRouletteResult(uint value, BetData bet, bytes32 betTx, uint paymentMutiplier) private croupierOnly {\r\n        uint result = value % ROULETTE_MAX_MOD;\r\n        uint payAmount = ROULETTE_BASE_STAKE * paymentMutiplier;\r\n        if (bet.player.send(payAmount)) {\r\n            emit RoulettePayment(bet.player, bet.gameId, payAmount, value, result, bet.amount, betTx, bet.betData);\r\n        } else {\r\n            emit PaymentFail(bet.player, payAmount);\r\n        }\r\n    }\r\n\r\n\r\n    function() public payable {\r\n    }\r\n\r\n    function withdraw(address add, uint amount) ownerOnly payable public {\r\n        add.transfer(amount);\r\n    }\r\n}","ABI":"[{\"constant\":false,\"inputs\":[{\"name\":\"value\",\"type\":\"uint256\"},{\"name\":\"blockHash\",\"type\":\"bytes32\"},{\"name\":\"betTx\",\"type\":\"bytes32\"},{\"name\":\"paymentMutiplier\",\"type\":\"uint256\"}],\"name\":\"doResult\",\"outputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"kill\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"croupier\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"c\",\"type\":\"address\"}],\"name\":\"setSigner\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"data\",\"type\":\"bytes\"},{\"name\":\"expiredBlockNum\",\"type\":\"uint256\"},{\"name\":\"commit\",\"type\":\"bytes32\"},{\"name\":\"r\",\"type\":\"bytes32\"},{\"name\":\"s\",\"type\":\"bytes32\"}],\"name\":\"doRouletteBet\",\"outputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"value\",\"type\":\"uint256\"},{\"name\":\"expiredBlockNum\",\"type\":\"uint256\"},{\"name\":\"commit\",\"type\":\"bytes32\"},{\"name\":\"r\",\"type\":\"bytes32\"},{\"name\":\"s\",\"type\":\"bytes32\"}],\"name\":\"doRollBet\",\"outputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"add\",\"type\":\"address\"},{\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"withdraw\",\"outputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"c\",\"type\":\"address\"}],\"name\":\"setCroupier\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"constructor\"},{\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"fallback\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"gamdId\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"commit\",\"type\":\"bytes32\"},{\"indexed\":false,\"name\":\"data\",\"type\":\"bytes\"}],\"name\":\"BetEvent\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"gameId\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"payAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"value\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"result\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"betAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"betValue\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"betTx\",\"type\":\"bytes32\"}],\"name\":\"RollPayment\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"gameId\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"payAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"value\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"result\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"betAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"betTx\",\"type\":\"bytes32\"},{\"indexed\":false,\"name\":\"betData\",\"type\":\"bytes\"}],\"name\":\"RoulettePayment\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"PaymentFail\",\"type\":\"event\"}]","ContractName":"WaRoll","CompilerVersion":"v0.4.24+commit.e67f0147","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"","Library":"","SwarmSource":"bzzr://c416a699c2ff7490096db74d97536c4619a67ade712379a245dd014f1793cce7"}]}